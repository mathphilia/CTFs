# stream
category: Crypto
390 points, 37 solves

## 問題
> HELP! I encrypted my files with this program I downloaded from the internet. Can you recover my 42-byte flag?

## 解法
ファイルを暗号化してくれるバイナリと暗号化されたファイルが渡されている。とりあえず`./stream`を実行すると

> [\*] Usage: ./stream [FILE] [KEY] [OUT]

と言われる。鍵KEYを使って平文FILEを暗号化して暗号文OUTを出力するもののようだ(問題名的にストリーム暗号だからそれはそうという気もするが)。まずは色々なKEYで暗号化を試す。簡単のため、平文は`b'\x00' * 10`にする。

```
KEY: "hoge" → OUT: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' (b'\x00' * 16)
KEY: "abcde" → OUT: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' (b'\x00' * 16)
KEY: "k5s9fj1hfukh9elejsqgmydd3ygg2k" → OUT: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' (b'\x00' * 16)
```

何じゃこれ？全然暗号化されんぞ？16bytesになっているからブロック長は8bytesか16bytesのようだが(平文を20bytesにすると出力が24bytesになるのでブロック長は8bytesと分かる)。諦めずに色々試してみると、

```
KEY: "12345abcde" → OUT: b'90\x00\x00\x00\x00\x00\x00\xb1l\x15\t\x00\x00\x00\x00'
KEY: "92dve8jkjnml1yftfr68ckbfhzv2t2" → OUT: b'\x5c\x00\x00\x00\x00\x00\x00\x00\x10\x21\x00\x00\x00\x00\x00\x00'
```

により暗号化できる。共通点を考えてみると、暗号化できないKEYは英文字から始まっていて、暗号化できるKEYは数字から始まっている。このことから、鍵を文字列としてではなく数として読み込んでいるものと推測できる。つまり、鍵"12345abcde"での暗号化は鍵12345での暗号化と、鍵"92dve8jkjnml1yftfr68ckbfhzv2t2"での暗号化は鍵92での暗号化と言い換えることができる。ということで鍵をいろいろな数にして試してみよう。

```
KEY: 0 → OUT: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
KEY: 1 → OUT: b'\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
KEY: 2 → OUT: b'\x02\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00'
KEY: 3 → OUT: b'\x03\x00\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x00\x00\x00\x00'
KEY: 4 → OUT: b'\x04\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00'
```

おや、もしかして、KEYが$k$のときの$n$ブロック目(0-based index)は$k^{n+1}$をlittle endianで表したものになっている…？2ブロックだと確信が持てないので10ブロックほど見てみよう(平文を80bytesにすると暗号文が88bytesになるので平文は`b'\x00' * 75`にした)。

```
KEY: 0 → OUT: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
KEY: 1 → OUT: b'\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
KEY: 2 → OUT: b'\x02\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
KEY: 3 → OUT: b'\x03\x00\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x00\x00\x00\x00\x51\x00\x00\x00\x00\x00\x00\x00\xa1\x19\x00\x00\x00\x00\x00\x00\x41\xd7\x90\x02\x00\x00\x00\x00\x81\x3e\x1e\xe2\x4f\x95\x06\x00\x01\xbd\x7e\x79\x8c\x27\x32\x79\x01\x7a\x86\x8a\x81\x14\x42\x80\x01\xf4\x30\x07\x2f\x5f\x10\xd2\x01\xe8\xf1\x76\x12\x0d\x66\x1d'
KEY: 4 → OUT: b'\x04\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
```

おや…何やら様子がおかしい。分かりやすそうなKEY=3について各ブロックが表す数値を見てみると、3, 9, 81, 6561, 43046721, 1853020188851841, 8733086111712066817, 9241971931925084673, 15136703003180987393, 2118395047680534529となっている。$3=3^1,9=3^2,81=3^4,6561=3^8,43046721=3^{16},1853020188851841=3^{32}$であるので、$n$ブロック目は$3^{2^n}$をlittle endianで表したものになっているらしい。6ブロック目からは$3^{2^n}$が8bytesに収まらないため$3^{2^n}\bmod2^{64}$になっている。一般に、KEYが$k$のときの$n$ブロック目(0-based index)は$k^{2^n}\bmod2^{64}$をlittle endianで表したものになっている。一般の平文に対しては以下のような処理が行われていると考えられる(実際確かめてみると正しそうだと分かる)。
1. 8bytesの倍数になるよう、平文に1bytes以上8bytes以下のパディングを施す
1. パディングされた平文のバイト長を$8\ell$とし、鍵を$k$とするとき、$K_n=k^{2^n}\bmod2^{64}$により定まる鍵ストリーム$K_1K_2K_3\cdots K_\ell$を求める($K_n$は8bytesでlittle endian)
1. パディングされた平文と鍵ストリームのxorをとり出力とする
以上で仕様が把握できたので復号に移る。flagは`ictf{`から始まることが分かっているので、鍵の左から5bytes目までは確定する。鍵の残りは3bytes、つまり16777216通りなので全探索可能であるから、全探索してすべてのbyteが128以下であるものを抽出するなどすればよい。

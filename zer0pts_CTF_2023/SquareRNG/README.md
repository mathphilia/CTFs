# SquareRNG
category: Crypto
130 points, 54 solves

## 問題
> I wrote a pseudorandom number generator. You can't guess the next bit without knowing each other's secret.  
> `nc crypto.2023.zer0pts.com 10666`

## 解法
**注) ガチャガチャやっていたら解けただけなので、以下は解説でなく思考のメモのようなものです。**  
以下、`sa`を $a$ ,`sb1`を $b_1$ ,`sb2`を $b_2$ と書く。 $b_1,b_2$ の値はこちらで自由に指定できるので、単純な値にしてみる。 $0$ は禁止されているので、 $b_1=1$ としてみる。このとき求めるべきは $a^{33}+1$ が $\bmod p$ で平方剰余か否かである。Legendreの記号の準同型性から、例えば $1+a$ と $1-a+a^2-\dots+a^{32}$ が平方剰余か調べれば目的は達せられる。しかし`r1.int(32)`から得られる情報は、  
$$\sum_{i=1}^n(ab_1)^i\quad(n=1,2,3,\dots,32)$$
がそれぞれ $\bmod p$ で平方剰余かだけである。今 $b_1=1$ であるから、 $1+a=\dfrac{a+a^2}a$ が平方剰余かは分かるが $1-a+a^2-\dots+a^{32}$ については分からなそうである。ここで $b_2=-1$ とすると、`r2.int(32)`の値から  
$$\sum_{i=1}^n(ab_2)^i=-a+a^2-a^3+\dots+(-a)^n\quad(i=1,2,3,\dots,32)$$
がそれぞれ平方剰余か分かるのでよさそうな気がする。ただ実際は $i=32$ のとき $-a+a^2-a^3+\dots+a^{32}$ が得られるが、これを使っても $1-a+a^2-\dots+a^{32}$ が平方剰余であるかは分からない。こんな感じで考えて行けばできそうな気がするが、思いつかなかったので少し考え方を変えてみる。つまるところ必要な情報は64bitのうち数bitだけでありそうだから、それがどのbitなのか推測すればflagはゲットできるのではないか。具体的には、 $a^{33}+1$ が $\bmod p$ で平方剰余か判断するのに十分なbitを $x_1,x_2,x_3,\dots,x_k$ と仮定し、 $p$ や $a$ の値を色々に変えながら`r1.int(32)`,`r2.int(32)`,`r1.bool()`の出力を調べ、「 $(x_1,x_2,x_3,\dots,x_k)$ が等しければ`r1.bool()`の出力が等しい」が成り立つかチェックする。もし成り立てば仮定は正しく $(x_1,x_2,x_3,\dots,x_k)\mapsto$ `r1.bool()`の辞書を作ってflagを貰いに行けばよい。実際に試してみると、`r1.int(32)`と`r2.int(32)`の各々の $1$ の位および $2^{31}$ の位を見ればよいことが分かる。  
とここまで書いて[他の方のwriteup](https://qiita.com/kusano_k/items/3c6809ff163e2edbe826)を見に行ったらミスに気付いた。`r1.int(32)`で与えられるのは  
$$\sum_{i={\color{red}0}}^n(ab_1)^i\quad(n=1,2,3,\dots,32)$$
であった。ソースコードで言えば`s`の初期値を見逃していたことになる。
